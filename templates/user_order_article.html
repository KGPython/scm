<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>商业供应链系统</title>
</head>
<body>
    {% load basefilter %}
    {% include "common/nav.html" %}
    <div class="query comWidth" style="width: 100%;text-align: right;">
        <form method="post" id="submitForm" action=""></form>
        <p>
            {% ifequal orderstatus.status 'Y'%}
                <input class="query-enter" type="button" value="打印" onclick="javascript:printContent()">
            {% else %}
                <input class="query-enter" type="button" id="saveBtn" value="保存确认" onclick="saveFun()">
            {% endifequal %}
            <input class="query-enter" type="button" value="返回" onclick="closeFun()">
        </p>
    </div>
    <div class="comWidth" style="width: 100%;text-align: center;">
         <p>
            该订单已经打印了&nbsp;<span style="color:dodgerblue;" id="printnumId">{{ order.printnum|default_if_none:"0" }}</span>&nbsp;次，请点击右上角的“保存确认“后再点击“打印“按钮打印，否则订单无效！
         </p>
    </div>
    <div class="notice noticeOrder comWidth" id="printContent" style="width: 100%">
          <div class="tTitle">
            <h1>{{ curgrpname }}<span class="red">{%if order.logistics == 1 %}直送{% else %}配送{% endif %}</span>订货单({{ shop.shopnm }} )</h1>
          </div>
          <table border="0" cellpadding="3" cellspacing="1" align="center" width="90%" style="background-color: #999;margin: 0 auto">
              <tbody>
                    <tr>
                          <td colspan="2" width="10%">单号</td>
                          <td colspan="2" width="35%" style="text-align: left;">{{ order.ordercode }}</td>
                          <td colspan="2" width="15%">机构编码</td>
                          <td  colspan="3" width="15%" style="text-align: left;">{{ order.shopcode }}</td>
                          <td  colspan="2" width="10%">订货日期</td>
                          <td  colspan="4" width="15%" style="text-align: left;">{{ order.purdate|date:"Y-m-d"  }}</td>
                    </tr>
                    <tr>
                          <td colspan="2">供应商编码</td>
                          <td colspan="2" style="text-align: left;">{{ order.spercode }}</td>
                          <td colspan="2">管理部类</td>
                          <td  colspan="3" style="text-align: left;">{{ order.teamcode }}</td>
                          <td  colspan="2">送货截止</td>
                          <td  colspan="4" style="text-align: left;">{{ order.sdate|date:"Y-m-d" }}</td>
                    </tr>
                     <tr>
                          <td colspan="2">供应商名称</td>
                          <td colspan="7" style="text-align: left;">{{ order.spername }}</td>
                          <td colspan="2">预约送货</td>
                          <td  colspan="4" align="left" style="width:16%;text-align: left;">
                                 {% ifequal orderstatus.status 'Y'%}
                                     {{ orderstatus.yyshdate|date:"Y-m-d" }}
                                 {% else %}
                                      <input class="inline laydate-icon" id="yyshdate" type="text" value="{{ orderstatus.yyshdate|date:"Y-m-d" }}" style="width:40%;padding-left: 5px;">
                                 {% endifequal %}
                          </td>
                    </tr>
                    <tr>
                          <td colspan="2">备注</td><td colspan="13" style="text-align: left;">{{ order.remark }}</td>
                    </tr>
                    <tr style="background-color:grey">
                          <td >序号</td>
                          <td>编码</td>
                          <td>商品条码</td>
                          <td>品名</td>
                          <td>单位</td>
                          <td>规格</td>
                          <td>件装</td>
                          <td>订数</td>
                          <td>实送</td>
                          <td>进价</td>
                          <td>含税金额</td>
                          <td>实收</td>
                          <td>实收金额</td>
                          <td>大件数量</td>
                          <td>生产日期</td>
                    </tr>
                    {% for row in detailList %}
                        <tr style="text-align: left;">
                              <td style="text-align: center;">{{ forloop.counter }}</td>
                              <td>{{ row.procode }}</td>
                              <td>{{ row.barcode }}</td>
                              <td>{{ row.pn }}</td>
                              <td style="text-align: center;">{{ row.unit }}</td>
                              <td style="text-align: center;">{{ row.classes|default_if_none:"" }}</td>
                              <td>{{ row.num|floatformat:0 }}</td>
                              <td style="color:dodgerblue;">{{ row.denums|floatformat:0 }}</td>
                              <td></td>
                              <td>{{ row.price_intax|floatformat:2 }}</td>
                              <td>{{ row.jshj|floatformat:2 }}</td>
                              <td></td>
                              <td></td>
                              <td></td>
                              <td></td>
                        </tr>
                    {% endfor %}
                    <tr class="tbottom" style="background-color: lightskyblue">
                          <td></td>
                          <td >合计</td>
                          <td></td>
                          <td></td>
                          <td></td>
                          <td></td>
                          <td></td>
                          <td><span class="noprint">{{ sum1|floatformat:0 }}</span></td>
                          <td></td>
                          <td><span class="noprint">{{ sum2|floatformat:2 }}</span></td>
                          <td><span class="noprint">{{ sum3|floatformat:2 }}</span></td>
                          <td colspan="4"></td>
                    </tr>
                    <tr class="tbottom" style="background-color: lightskyblue">
                          <td ></td>
                          <td ></td>
                          <td colspan="2">收货员</td>
                          <td colspan="4">防损员</td>
                          <td colspan="7">供货商</td>
                    </tr>
                    <tr class="tbottom">
                          <td ></td>
                          <td >签字处</td>
                          <td colspan="2"></td>
                          <td colspan="4"></td>
                          <td colspan="7"></td>
                    </tr>
                    <tr class="tbottom" >
                          <td colspan="2">说明</td>
                          <td colspan="13" style="text-align: left;"><span class="noprint">A4纸打印。</span>导入：{{ order.scmpurdate|date:"Y-m-d" }}&emsp;打印：{{ today|date:"Y-m-d" }}&emsp;审核：{{ order.checker }}&emsp;地址：{{ shop.address|trim  }}{% ifnotequal shop.tel "" %}-{{ shop.tel}}{% endifnotequal %}</td>
                    </tr>
              </tbody>
          </table>
    </div>
    {% include "common/footer.html" %}
    <script type="text/javascript">
        current = "dinghuo"
        //ajax提交设置csrf
        $.ajaxSetup({
            dataType: "json",
            beforeSend: function(xhr, settings){
                var csrftoken = $.cookie('csrftoken');
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            },
        });

        //打印
        function printContent(){
            $("#printContent").jqprint();
            //计算打印次数
            $.post('/scm/base/supp/order/upprint/', {ordercode: '{{order.ordercode}}'}, function (result, status) {
                    $("#printnumId").html(result.printnum);
            });
        }
        //关闭窗口
        function closeFun(){
            window.opener.location.reload();
            self.close();
        }

        //截至日期、制单日期
        function saveFun(){
             //1.验证表单
            sdate = "{{ order.sdate|date:"Y-m-d"  }}";
            purdate = "{{ order.purdate|date:"Y-m-d"  }}";
            var today = getToday();

            //截止日期 >= 今日
            if(dateDiff(sdate,today) < 0){
                alert("订单超过送货截至日期，无法保存！");
                return false;
            }
            //预期送货日期 < 今日
            if($("#yyshdate")==undefined || $("#yyshdate").val()==''){
                alert("预期送货日期不能为空");
                return false;
            }
            var yyshdate = $("#yyshdate").val();
            if(dateDiff(yyshdate,today) < 0){
                alert("预期送货日期不能晚于今日");
                return false;
            }
            //预期送货日期 > 截止日期
            if(dateDiff(yyshdate,sdate) > 0){
                alert("预期送货日期不能晚于送货截止日期");
                return false;
            }

            var ajax_option= {
                url: "/scm/base/supp/order/save/",
                data:{"yyshdate":yyshdate,"ordercode":"{{ order.ordercode }}"},
                type:'post',
                dataType:'json',
                async:false,
                cache: false,
                beforeSubmit:function(a,f,o){
                    $("#saveBtn").attr({ disabled: "disabled" });
                },
                success: function (data) {
                    window.location.reload();
                    if(data.result=='success'){
                            alert("保存确认成功");
                    }else{
                            alert("保存确认失败")
                    }
                    $("#saveBtn").attr({ disabled: "none" });
                }
            }

            $('#submitForm').ajaxSubmit(ajax_option);
        }

        //获取今天日期   格式 yyyy-MM-dd
        function getToday(){
            var now = new Date();
            var year=now.getFullYear();
            var month=now.getMonth()+1;
            var data=now.getDate();
                 if(month < 10){
                     month="0"+month;
                 }

                 if(data < 10){
                     data="0"+data;
                 }
            return year+"-"+month+"-"+data;
        }
        //计算两个日期的天数差：sdate1 - sdate2 = idays
        // 如 idays > 0 则 sdate1 > sdate2
        // 如 idays = 0 则 sdate1 = sdate2
        // 如 idays < 0 则 sdate1 < sdate2
        function dateDiff(sdate1,sdate2){
            var adate,odate1,odate2,idays ;
            adate =sdate1.split('-');
            odate1 = new Date(adate[1]+'-'+adate[2]+'-'+adate[0]) ;
            //转换为04-19-2007格式
            adate = sdate2.split('-');
            odate2 = new Date(adate[1]+'-'+ adate[2] +'-'+adate[0]);

            idays = parseInt((odate1 - odate2)/1000/60/60/24);//把相差的毫秒数转换为天数 Math.abs()

            return idays ;
         }

        //定义日期样式
        !function(){
            laydate.skin('molv');//切换皮肤，请查看skins下面皮肤库
        }();

        //日期范围限制
        var start = {
            elem: '#start',
            format: 'YYYY-MM-DD',
            //min: laydate.now(), //设定最小日期为当前日期
            max: '2099-06-16', //最大日期
            istime: true,
            istoday: false,
            choose: function(datas){
               end.min = datas; //开始日选好后，重置结束日的最小日期
               end.start = datas //将结束日的初始值设定为开始日
            }
        };

        var end = {
            elem: '#end',
            format: 'YYYY-MM-DD',
            //min: laydate.now(),
            max: '2099-06-16',
            istime: true,
            istoday: false,
            choose: function(datas){
              start.max = datas; //结束日选好后，充值开始日的最大日期
            }
        };

        var yyshdate = {
            elem: '#yyshdate',
            format: 'YYYY-MM-DD',
            //min: laydate.now(), //设定最小日期为当前日期
            max: '2099-06-16', //最大日期
            istime: true,
            istoday: false,
            choose: function(datas){
               end.min = datas; //开始日选好后，重置结束日的最小日期
               end.start = datas //将结束日的初始值设定为开始日
            }
        };

        laydate(start);
        laydate(end);
        laydate(yyshdate);
    </script>
</body>
</html>
